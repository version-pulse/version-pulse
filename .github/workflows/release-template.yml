# .github/workflows/release-template.yml
name: Generate Release Note

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      tag_name:
        required: true
        type: string
    outputs:
      release_note:
        description: 'Generated release note'
        value: ${{ jobs.generate.outputs.release_note }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      release_note: ${{ steps.generate.outputs.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Release Notes
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            
            // PR ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸°
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            // PR ë‚´ìš© ë¶€ë¶„ ì¶”ì¶œ
            const prBody = pullRequest.body || '';
            const workSectionMatch = prBody.match(/### ğŸ” ì‘ì—… ë‚´ìš©\s*([\s\S]*?)(?:^### |\Z)/m);
            const workSection = workSectionMatch ? workSectionMatch[1].trim() : '';
            const todoSectionMatch = prBody.match(/### ğŸ”§ ì¶”ê°€ ê°œì„  í•„ìš” ì‚¬í•­\s*([\s\S]*?)(?:^### |\Z)/m);
            const todoSection = todoSectionMatch ? todoSectionMatch[1].trim() : '';
            
            // ì»¤ë°‹ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            let commitMessages = commits.map(commit => ({
              message: commit.commit.message,
              sha: commit.sha
            }));
            const categories = {
              feat: [],
              fix: [],
              refactor: [],
              docs: [],
              chore: [],
              deploy: [],
              test: [],
              other: []
            };

            commitMessages.forEach(({ message, sha }) => {
              const shortSha = sha.substring(0, 7);
            
              if (/.*Feat[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.feat.push(`${parsed} (${shortSha})`);
              } else if (/.*Fix[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.fix.push(`${parsed} (${shortSha})`);
              } else if (/.*Refac[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.refactor.push(`${parsed} (${shortSha})`);
              } else if (/.*Docs[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.docs.push(`${parsed} (${shortSha})`);
              } else if (/.*Chore[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.chore.push(`${parsed} (${shortSha})`);
              } else if (/.*Deploy[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.deploy.push(`${parsed} (${shortSha})`);
              } else if (/.*Test[:\s]/.test(message)) {
                const parsed = message.replace(/^\[.*?\]\s*\w*:\s*/, '');
                categories.test.push(`${parsed} (${shortSha})`);
              }
            });

            let releaseNote = `# ğŸš€ version-pulse ${{ inputs.tag_name }} (${new Date().toISOString().split('T')[0]})\n`;
            releaseNote += `${workSection}\n\n`;

            if (categories.feat.length > 0) {
              releaseNote += `---\n### âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥\n`;
              categories.feat.forEach(item => releaseNote += `- ${item.replace(/^Feat:\s*/, '')}\n`);
              releaseNote += '\n';
            }

            if (categories.fix.length > 0) {
              releaseNote += `---\n### ğŸ› ë²„ê·¸ ìˆ˜ì • (Bug Fixes)\n`;
              categories.fix.forEach(item => releaseNote += `- ${item.replace(/^Fix:\s*/, '')}\n`);
              releaseNote += '\n';
            }

            if (categories.refactor.length > 0) {
              releaseNote += `---\n### ğŸ›  ë¦¬íŒ©í† ë§ ë° ê°œì„ \n`;
              categories.refactor.forEach(item => releaseNote += `- ${item.replace(/^Refac:\s*/, '')}\n`);
              releaseNote += '\n';
            }

            if (categories.docs.length > 0 || categories.chore.length > 0 || categories.deploy.length > 0) {
              releaseNote += `---\n### âš™ï¸ ë¹Œë“œ ë° ë°°í¬ ê´€ë ¨\n`;
              [...categories.docs, ...categories.chore, ...categories.deploy].forEach(item => releaseNote += `- ${item.replace(/^(Docs|Chore|Deploy):\s*/, '')}\n`);
              releaseNote += '\n';
            }

            if (todoSectionMatch.length > 0) {
              releaseNote += `---\n### ğŸ“Œ ì¶”ê°€ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„\n`;
              releaseNote += `${todoSectionMatch}\n`;
            }
            
            releaseNote += `\n---\nğŸ”— [Mavenì €ì¥ì†Œ](https://central.sonatype.com/artifact/io.github.version-pulse/app/${{ inputs.tag_name }})`;
            
            console.log("âœ… Generated Release Note:\n" + releaseNote);
            return releaseNote;
